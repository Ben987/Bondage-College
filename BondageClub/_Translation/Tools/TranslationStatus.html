<!DOCTYPE html>
<html style="width:100%; height:100%; padding:0px; margin:0px;">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
<meta http-equiv="cache-control" content="max-age=0" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="expires" content="0" />
<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
<meta http-equiv="pragma" content="no-cache" />
<meta charset="UTF-8">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Bondage Club Translation Status</title>
<link rel="icon" type="image/png" href="../../Icons/Logo.png">

<style>
    body {
        font-family: sans-serif;
    }

    #LanguageWrapper {
        padding-left: 1em;
    }

    .LanguageReportContainer {
        padding-left: 2em;
    }

    .TranslationFileTitle,
    .TranslationFileSummary {
        display: inline-block;
    }

    .TranslationFileDetails {
        padding-left: 1em;
    }

    .Status {
        display: inline-block;
        padding: 0.5em 1em;
        margin: 0 0.5em;
        font-weight: bold;
        border-radius: 5px;
        background-color: #555;
        color: #fff;
    }

    .Status.Ok {
        background-color: #080;
    }

    .Status.Error {
        background-color: #f00;
    }

    .Status.Warning {
        background-color: #ff0;
        color: #000;
    }

    .Status.Info {
        background-color: #00f;
    }
</style>

<script src="../../Scripts/Common.js"></script>
<script src="../../Scripts/Translation.js"></script>
<script>

/*	
    TO DO
    Check for...
    * Duplicate strings in translation
    * Strings that are too long (more than 2 lines for player or more than 3 lines for npc)
    * Identical string translated differently in another file of the same language
*/

var EnglishFiles = {};

//
window.onload = function() {
	for (var L = 0; L < TranslationDictionary.length; L++) {
        var Language = TranslationDictionary[L];
        if (Language.LanguageCode === "EN") continue;

        CreateLanguageReport(Language);
    }
};

function CreateLanguageReport(Language) {
    var MainContainer = document.getElementById("LanguageWrapper");
    var Title = document.createElement("h2");
    Title.textContent = Language.EnglishName + " (" + Language.LanguageName + ")";
    Language.Container = document.createElement("div");
    Language.Container.className = "LanguageReportContainer";
    Language.Container.id = "Language_" + Language.LanguageCode;
    MainContainer.appendChild(Title);
    MainContainer.appendChild(Language.Container);

    Language.Data = [];
    for (var F = 0; F < Language.Files.length; F++) {
        CreateFileStatusReport(Language, Language.Files[F]);
    }
}

function CreateFileStatusReport(Language, Path) {
    var Status = {};
    Language.Data.push(Status);
    Status.Path = Path;

    Status.Container = document.createElement("div");
    Status.Container.className = "FileStatusContainer";
    Status.Container.id = Language.Container.id + "_" + Status.Path
    Language.Container.appendChild(Status.Container);

    var FileTitle = document.createElement("h3");
    FileTitle.className = "TranslationFileTitle";
    FileTitle.textContent = Status.Path;
    Status.Container.appendChild(FileTitle);

    Status.Summary = document.createElement("div");
    Status.Summary.className = "TranslationFileSummary";
    Status.Container.appendChild(Status.Summary);
    AddStatusReport(Status, "Processing", "Processing...");

    var EnglishPath = Status.Path.substring(0, Status.Path.length - 7) + ".csv";
    // TODO: Find a way to avoid requesting the same file multiple times (the file may have already been requested but not yet recieved)
    var Callback = function() {
        if (!EnglishFiles[EnglishPath]) {
            EnglishFiles[EnglishPath] = {Data: CommonParseCSV(this.responseText)};
            ProcessEnglishFile(EnglishFiles[EnglishPath]);
        }
        Status.EnglishFile = EnglishFiles[EnglishPath];
        GetDataAndAnalyze(Status);
    }
    CommonGet("../../" + EnglishPath, Callback);
}

function ProcessEnglishFile(File) {
    File.UniqueLines = [];
    var TextColumns;
    if (File.Data[0].length == 2) TextColumns = [1];
    else if (File.Data[0].length == 3) TextColumns = [2];
    else TextColumns = [2, 3];
    for (var L = 0; L < File.Data.length; L++) {
        for (var C = 0; C < TextColumns.length; C++) {
            var Text = File.Data[L][TextColumns[C]];
            if (File.UniqueLines.indexOf(Text) < 0) File.UniqueLines.push(Text.replace("\r", ""));
        }
    }
}

function GetDataAndAnalyze(Status) {
    CommonGet("../../" + Status.Path, function() {
        Status.RawData = this.responseText;
        var Lines = Status.RawData.split("\n");
        Status.Data = [];
        var Speaker = null;
        for (var L = 0; L < Lines.length; L++) {
            if (L + 1 >= Lines.length) break;
            var Line = Lines[L].replace("\r", "");
            if (Line.startsWith("###_")) {
                Speaker = Line.substring(4);
                continue;
            }
            if (Line.startsWith("###")) {
                continue;
            }
            var DataSet = {};
            DataSet.Speaker = Speaker;
            DataSet.English = Line;
            DataSet.Line = L + 1;
            var Translation;
            do {
                Translation = Lines[++L]
            } while (Translation && Translation.startsWith("###"));
            DataSet.Translation = Translation;
            Status.Data.push(DataSet);
        }
        AnalyzeStatus(Status);
    });
}

function AnalyzeStatus(Status) {
    Status.MissingTranslations = [];
    LoopLines: for (var L = 0; L < Status.EnglishFile.UniqueLines.length; L++) {
        var Text = Status.EnglishFile.UniqueLines[L];
        if (Text.trim() === "") continue;
        for (var T = 0; T < Status.Data.length; T++) {
            if (Status.Data[T].English && Status.Data[T].English === Text) continue LoopLines; // TODO: Keep looping to find duplicates
        }
        Status.MissingTranslations.push(Text);
    }
    Status.ObsoleteTranslations = [];
    for (var T = 0; T < Status.Data.length; T++) {
        if (Status.EnglishFile.UniqueLines.indexOf(Status.Data[T].English) < 0) {
            Status.ObsoleteTranslations.push(Status.Data[T]);
        }
    }
    Status.UntranslatedLines = [];
    for (var T = 0; T < Status.Data.length; T++) {
        if (Status.Data[T].English.trim() === Status.Data[T].Translation.trim() || Status.Data[T].Translation.trim() === "")
            Status.UntranslatedLines.push(Status.Data[T]);
    }
    CreateStatusSummary(Status);
}

function CreateStatusSummary(Status) {
    Status.Summary.innerHTML = "";
    var Ok = true;
    if (Status.MissingTranslations.length > 0) {
        Ok = false;
        AddStatusReport(Status, "Error", Status.MissingTranslations.length + " lines missing");
    }
    if (Status.ObsoleteTranslations.length > 0) {
        Ok = false;
        AddStatusReport(Status, "Warning", Status.ObsoleteTranslations.length + " lines not used");
    }
    if (Status.UntranslatedLines.length > 0) {
        Ok = false;
        AddStatusReport(Status, "Error", Status.UntranslatedLines.length + " lines not translated");
    }
    if (Ok) {
        AddStatusReport(Status, "Ok", "OK");
    } else {
        var Button = document.createElement("button");
        Button.textContent = "View Details";
        Button.addEventListener("click", function() {
            Button.setAttribute("disabled", "true");
            ViewDetails(Status);
        });
        Status.Summary.appendChild(Button);
    }
}

function ViewDetails(Status) {
    if (Status.Details) return;
    Status.Details = document.createElement("div");
    Status.Details.className = "TranslationFileDetails";
    Status.Container.appendChild(Status.Details);
    if (Status.MissingTranslations.length > 0) {
        AddNodeWithText(Status.Details, "h4", "These lines are missing in the translation file (either added or changed from previous version):");
        var List = document.createElement("ul");
        Status.Details.appendChild(List);
        for (var Line of Status.MissingTranslations) AddNodeWithText(List, "li", Line);
    }
    if (Status.ObsoleteTranslations.length > 0) {
        AddNodeWithText(Status.Details, "h4", "These lines from the translation file do not appear in the original script (check if they were changed or deleted):");
        var List = document.createElement("dl");
        Status.Details.appendChild(List);
        for (var Data of Status.ObsoleteTranslations) {
            AddNodeWithText(List, "dt", "Line " + Data.Line + ":");
            AddNodeWithText(List, "dd", Data.English);
        }
    }
    if (Status.UntranslatedLines.length > 0) {
        AddNodeWithText(Status.Details, "h4", "These lines appear not to be translated:");
        var List = document.createElement("dl");
        Status.Details.appendChild(List);
        for (var Data of Status.UntranslatedLines) {
            AddNodeWithText(List, "dt", "Line " + Data.Line + ":");
            AddNodeWithText(List, "dd", Data.English);
        }
    }
}

function AddStatusReport(Status, Type, Text) {
    var Element = document.createElement("span");
    Element.textContent = Text;
    Element.className = "Status " + Type;
    Status.Summary.appendChild(Element);
}

function AddNodeWithText(Parent, Tag, Text) {
    var Element = document.createElement(Tag);
    Element.textContent = Text;
    Parent.appendChild(Element);
    return Element;
}

</script>

</head>

<body>
    <h1>Bondage Club Translation Status Report</h1>
    <p>This tool processes all translation files that are currently referenced inside Translation.js. Its main purpose is to check if all translation files are up to date and if there are any potential problems. If a status displays something other than &quot;OK&quot;, click the &quot;View Details&quot; button to learn more.</p>
    <p>Please note that this tool isn't perfect and is supposed to merely assist the translation process by offering suggestions. Some of the reports may be false alarms, so please use your own judgement to decide if they need to be addressed.</p>
    <div id="LanguageWrapper"></div>
</body>
</html>
